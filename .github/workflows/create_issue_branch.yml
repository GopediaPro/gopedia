# .github/issue-branch.yml

# GitHub Action: Issue Branch
on:
  issues:
    types:
      - opened
      - labeled
      - unlabeled
      - reopened

jobs:
  create_branch:
    # ì´ìŠˆê°€ ì—´ë ¸ì„ ë•Œë§Œ ì‹¤í–‰ (ì„ íƒì )
    if: github.event.action == 'opened' || github.event.action == 'reopened'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Calculate Branch Variables
        id: calculate_vars
        run: |
          # 1. ISSUE NUMBER (í•„ìˆ˜)
          ISSUE_NUMBER=${{ github.event.issue.number }}
          
          # 2. MILESTONE (ë§ˆì¼ìŠ¤í†¤ ë¶€ì¬ ì‹œ common)
          MILESTONE_TITLE="${{ github.event.issue.milestone.title }}"
          if [ -z "$MILESTONE_TITLE" ]; then
            MILESTONE_SLUG="common"
          else
            # ì†Œë¬¸ì ë³€í™˜ ë° ê³µë°±/íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬
            MILESTONE_SLUG=$(echo "$MILESTONE_TITLE" | tr '[:upper:]' '[:lower:]' | tr -c '[:alnum:]\n' '-')
          fi
          
          # 3. LABELS (ë ˆì´ë¸” ë‹¤ìˆ˜ ì‹œ common)
          LABEL_JSON='${{ toJSON(github.event.issue.labels) }}'
          # ë ˆì´ë¸” ê°œìˆ˜ ê³„ì‚° (jq ì‚¬ìš©)
          LABEL_COUNT=$(echo "$LABEL_JSON" | jq 'length')
          
          if [ "$LABEL_COUNT" -gt 1 ]; then
            LABEL_SLUG="common"
          else
            # ë ˆì´ë¸”ì´ 1ê°œì¼ ê²½ìš° í•´ë‹¹ ë ˆì´ë¸” ì‚¬ìš© (ìŠ¬ëŸ¬ê·¸ ì²˜ë¦¬)
            FIRST_LABEL=$(echo "$LABEL_JSON" | jq -r '.[0].name // empty')
            if [ -z "$FIRST_LABEL" ]; then
              LABEL_SLUG="no-label" # ë ˆì´ë¸”ì´ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
            else
              LABEL_SLUG=$(echo "$FIRST_LABEL" | tr '[:upper:]' '[:lower:]' | tr -c '[:alnum:]\n' '-')
            fi
          fi
          
          # 4. ISSUE TYPE (ì´ìŠˆ í…œí”Œë¦¿ì˜ form í•„ë“œì—ì„œ ê°€ì ¸ì˜¤ê¸°)
          ISSUE_BODY='${{ github.event.issue.body }}'
          # ì´ìŠˆ ë³¸ë¬¸ì—ì„œ "Issue Type" ì„¹ì…˜ ë‹¤ìŒ ì¤„ì˜ ê°’ì„ ì¶”ì¶œ
          ISSUE_TYPE_LABEL=$(echo "$ISSUE_BODY" | grep -A 1 "ğŸ”– Issue Type" | tail -1 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
          
          if [ -z "$ISSUE_TYPE_LABEL" ]; then
            ISSUE_TYPE_SLUG="misc"
          else
            ISSUE_TYPE_SLUG=$(echo "$ISSUE_TYPE_LABEL" | tr '[:upper:]' '[:lower:]' | tr -c '[:alnum:]\n' '-')
          fi
          
          # 5. WORKER (user.name ê¸°ë°˜, ì—†ìœ¼ë©´ SKIP)
          # ì‚¬ìš©ì ì´ë¦„ì—ëŠ” íŠ¹ìˆ˜ë¬¸ìê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìŠ¬ëŸ¬ê·¸ ì²˜ë¦¬
          USER_NAME="${{ github.event.issue.user.login }}"
          if [ -z "$USER_NAME" ]; then
            WORKER_SLUG=""
          else
            WORKER_SLUG=$(echo "$USER_NAME" | tr '[:upper:]' '[:lower:]' | tr -c '[:alnum:]\n' '-')
            # Workerê°€ ìˆìœ¼ë©´ ì ‘ë‘ì‚¬ '-' ì¶”ê°€
            WORKER_SLUG="-$WORKER_SLUG"
          fi

          # ìµœì¢… ë¸Œëœì¹˜ ì´ë¦„ êµ¬ì„±
          BRANCH_NAME="${MILESTONE_SLUG}/${LABEL_SLUG}/${ISSUE_TYPE_SLUG}/${ISSUE_NUMBER}${WORKER_SLUG}"
          
          # GitHub Action ê²°ê³¼ ë³€ìˆ˜ë¡œ ì„¤ì •
          echo "MILESTONE_SLUG=$MILESTONE_SLUG" >> $GITHUB_OUTPUT
          echo "LABEL_SLUG=$LABEL_SLUG" >> $GITHUB_OUTPUT
          echo "ISSUE_TYPE_SLUG=$ISSUE_TYPE_SLUG" >> $GITHUB_OUTPUT
          echo "WORKER_SLUG=$WORKER_SLUG" >> $GITHUB_OUTPUT
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          echo "Generated Branch Name: $BRANCH_NAME"
      - name: Get SHA of the main branch
        id: get_main_sha
        # main ë¸Œëœì¹˜ì˜ ìµœì‹  ì»¤ë°‹ SHAë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        run: |
          MAIN_SHA=$(git ls-remote origin main | awk '{print $1}')
          echo "MAIN_SHA=$MAIN_SHA" >> $GITHUB_OUTPUT

      - name: Create Issue Branch with action-create-branch
        uses: peterjgrainger/action-create-branch@v3.0.0
        with:
          branch: ${{ steps.calculate_vars.outputs.BRANCH_NAME }}
          # main ë¸Œëœì¹˜ ê¸°ë°˜ìœ¼ë¡œ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ SHAë¥¼ ëª…ì‹œí•©ë‹ˆë‹¤.
          sha: ${{ steps.get_main_sha.outputs.MAIN_SHA }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # ì´ìŠˆê°€ ë‹«í ë•Œ ë¸Œëœì¹˜ ìë™ ì‚­ì œ (ì„ íƒ ì‚¬í•­)
          delete-branch-on-close: true